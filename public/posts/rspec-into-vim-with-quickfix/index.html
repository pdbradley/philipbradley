<!DOCTYPE html>
<html lang="en">




<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    
    Rspec Into Vim With Quickfix
     | Philip Bradley 
  </title>
  <link rel="stylesheet" href='http://www.philipbradley.net/css/site.min.eb4797a608f467160f71b5cc518dffb9b3fef0edc95e6def8dc4033ba1888b8f414e3d1d3e6c9804ca3e6f125539d8af48b28dcecb4eafc5805bde0b3c8d6956.css' integrity='sha512-60eXpgj0ZxYPcbXMUY3/ubP&#43;8O3JXm3vjcQDO6GIi49BTj0dPmyYBMo&#43;bxJVOdivSLKNzstOr8WAW94LPI1pVg=='>
  <link rel="canonical" href="http://www.philipbradley.net/posts/rspec-into-vim-with-quickfix/">
  <link rel="alternate" type="application/rss&#43;xml" href="http://www.philipbradley.net/index.xml" title="Philip Bradley">
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="author" content="Philip Bradley">
<meta name="description" content="Jump straight to your rspec error locations from Vim using this nifty trick with the quickfix window">

<meta property="og:title" content="Rspec Into Vim With Quickfix" />
<meta property="og:description" content="Jump straight to your rspec error locations from Vim using this nifty trick with the quickfix window" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.philipbradley.net/posts/rspec-into-vim-with-quickfix/" />
<meta property="article:published_time" content="2015-10-21T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-01-01T19:14:28-05:00" />


</head>
<body><nav class="navbar is-transparent " role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <a class="navbar-item" href="http://www.philipbradley.net/">
      <figure class="image">
        <img alt="" class="is-rounded" src="https://www.gravatar.com/avatar/17335e97ee934bff90fe4ddcaf0bb5fd?s=128&d=identicon">
      </figure>
    </a>
    <a class="navbar-item" href="http://www.philipbradley.net/">
      Philip Bradley
    </a>
  </div>
  
  <div class="navbar-menu">
    <div class="navbar-start">
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/ack/">
        
        Ack
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/activerecord/">
        
        Activerecord
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/bootcamps/">
        
        Bootcamps
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/capybara/">
        
        Capybara
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/flashcards/">
        
        Flashcards
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/git/">
        
        Git
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/rails/">
        
        Rails
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/refactoring/">
        
        Refactoring
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/ripgrep/">
        
        Ripgrep
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/rspec/">
        
        Rspec
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/ruby/">
        
        Ruby
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/search/">
        
        Search
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/vim/">
        
        Vim
        
      </a>
      
    </div>
    
    <div class="navbar-end">
      
      <a class="navbar-item" href="https://github.com/orf/" rel="noopener" target="_blank">
        <span class="icon">
          <img alt="github-circle" src='http://www.philipbradley.net/icons/svg/github-circle.svg'>
        </span>
      </a>
      
      <a class="navbar-item" href="mailto:nope@example.com" target="_blank">
        <span class="icon">
          <img alt="email" src='http://www.philipbradley.net/icons/svg/email.svg'>
        </span>
      </a>
      <a class="navbar-item" href="http://www.philipbradley.net/index.xml" target="_blank">
        <span class="icon">
          <img alt="rss" src='http://www.philipbradley.net/icons/svg/rss.svg'>
        </span>
      </a>
      
    </div>
  </div>
</nav>
<section class="hero is-small is-info is-fullwidth">
  <div class="hero-body">
<div class="container">
  <h1 class="title">
    Rspec Into Vim With Quickfix
  </h1>
  <h2 class="subtitle">
    <time datetime='2015-10-21T00:00:00Z'>
      October 21, 2015
    </time>
    
    <br>
    
    
    
    <a class="tag is-link" href="http://www.philipbradley.net/tags/ruby/">ruby</a>
    
    
    
    
    <a class="tag is-link" href="http://www.philipbradley.net/tags/rspec/">rspec</a>
    
    
    
  </h2>
</div>

  </div>
</section>
<section class="section">
  <div class="container">
<div class="content is-medium">
  <p>If you, live and die by TDD you probably started spending a lot of time writing tests which drive most of the application code you write.  Red, Green, Refactor, etc.  My tool of choice is Rspec, although Minitest is also quite nice.</p>
<p>Maybe I just have lazy eyes, but I get tired of scanning the pane where my tests run to find the exact location of each test failure, then navigating to it.  I'm pretty fast with vim file navigation, but I wanted a better way.</p>
<p>Enter the <a href="http://vimdoc.sourceforge.net/htmldoc/quickfix.html">quickfix</a>
feature in Vim.  It was originally conceived to save error messages from compilers and allow you to to jump from the list of errors to the actual location of the errors, one by one.  Yeah so that's exactly what we want to do with our Rspec errors, right?  It's just a matter of formatting the rspec output to match what quickfix expects.</p>
<p>So what does quickfix expect?  The vim docs are a little daunting, but one really simple format quickfix understands is:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#f92672">&lt;</span>filename_with_relative_path<span style="color:#f92672">&gt;</span><span style="color:#e6db74">:&lt;</span>line_number<span style="color:#f92672">&gt;</span><span style="color:#e6db74">:&lt;</span>message_about_error<span style="color:#f92672">&gt;</span></code></pre></div>
<p>Just three chunks of info separated by two colons.</p>
<p>Furthermore you can open up <em>any</em> file as a quickfix file with the vim command</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#e6db74">:cg</span> <span style="color:#f92672">&lt;</span>filename<span style="color:#f92672">&gt;</span><span style="color:#f92672">.</span></code></pre></div>
<p>Just for giggles, go into your rails project, create a file in the root folder called &ldquo;quickfix&rdquo; and put this on the first couple lines:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#f92672">.</span>/<span style="color:#e6db74">Gemfile</span>:<span style="color:#ae81ff">5</span><span style="color:#f92672"></span><span style="color:#e6db74">:Just</span> some random place <span style="color:#66d9ef">in</span> my project
<span style="color:#f92672">.</span>/config<span style="color:#f92672">/</span>database<span style="color:#f92672">.</span>yml:<span style="color:#ae81ff">10</span><span style="color:#f92672"></span><span style="color:#e6db74">:I</span><span style="color:#e6db74">&#39;m on line ten but I&#39;</span>m <span style="color:#f92672">not</span> sure why!</code></pre></div>
<p>Now open up vim (in that same project) and use the :cg command to open up your quickfix file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#e6db74">:cg</span> quickfix</code></pre></div>
<p>You can navigate to the quickfix split and press return on either of those two lines; vim will shoot you to the exact referenced line in each file.</p>
<p>So what we want is to get our rspec errors to end up in this quickfix format so that they will be in a nice tidy list, and so we can quickly jump straight to the failing test in our code.</p>
<p>Rspec has a few built in formatters, like &ldquo;documentation&rdquo; or &ldquo;progress&rdquo; that you can specify with the &ndash;format flag from the command line.  But you can also define your own <a href="https://www.relishapp.com/rspec/rspec-core/v/3-3/docs/formatters/custom-formatters">custom formatter</a> with which you override the methods you want to modify.</p>
<p>You just have to make a Ruby class.  I found a few out on the interwebs. There's one at <a href="https://github.com/dapplebeforedawn/vim-rspec-quickfix">vim-rspec-quickfix</a> but I felt that his formatter was a bit over complicated. Here's a simpler one that I prefer that I found at <a href="http://digitalronin.github.io/coding/2014/10/31/rspec3--vim-quickfix-list/">digitalronin</a>. I modified it ever-so-slightly (name change):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">QuickfixFormatter</span>
  <span style="color:#66d9ef">RSpec</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Core</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Formatters</span><span style="color:#f92672">.</span>register self, <span style="color:#e6db74">:example_failed</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e"></span><span style="color:#f92672"></span><span style="color:#a6e22e">initialize</span>(output)
    @output <span style="color:#f92672">=</span> output
  <span style="color:#66d9ef">end</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e"></span><span style="color:#f92672"></span><span style="color:#a6e22e">example_failed</span>(notification)
    @output <span style="color:#f92672">&lt;&lt;</span> format(notification) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">end</span>

  <span style="color:#66d9ef">private</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e"></span><span style="color:#f92672"></span><span style="color:#a6e22e">format</span>(notification)
    rtn <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s: %s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> <span style="color:#f92672">[</span>notification<span style="color:#f92672">.</span>example<span style="color:#f92672">.</span>location, notification<span style="color:#f92672">.</span>exception<span style="color:#f92672">.</span>message<span style="color:#f92672">]</span>
    rtn<span style="color:#f92672">.</span>gsub(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#39; &#39;</span>)<span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672"></span>,<span style="color:#ae81ff">160</span><span style="color:#f92672"></span><span style="color:#f92672">]</span>
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<p>What's going on in this class?  You need to <strong>register</strong> the notification that your custom formatter supports (we are only customizing <em>example_failed</em> notifications), and then you write a custom method for that type of notification.  Our custom example_failed method adds a notification to @output that consists of the location of the failed example, plus the associated message.</p>
<p>Because I don't want to copy this file into all of my rails projects, I keep it in my ~/code/rspec_support/ folder so all my projects can refer to it.</p>
<p>And you need to tell rspec to use this custom formatter when you run your tests.  Rspec can use multiple formatters at the same time, so you don't have to give up on seeing whatever you normally see when your tests run.  But using your custom formatter will let you generate a quickfix list quietly alongside:</p>
<p>From within my rails projects, now:</p>
<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">rspec <span style="color:#f92672">-</span><span style="color:#f92672">-</span>format progress <span style="color:#f92672">-</span><span style="color:#f92672">-</span>require <span style="color:#f92672">~</span><span style="color:#e6db74">/</span><span style="color:#e6db74">code</span><span style="color:#e6db74">/</span>rspec_support<span style="color:#f92672">/</span>quickfix_formatter<span style="color:#f92672">.</span>rb <span style="color:#f92672">-</span><span style="color:#f92672">-</span>format <span style="color:#66d9ef">QuickfixFormatter</span> <span style="color:#f92672">-</span><span style="color:#f92672">-</span>out quickfix<span style="color:#f92672">.</span>out spec</code></pre></div>
This runs my specs with &ldquo;progress&rdquo; visual formatting, but also requires my custom formatter class and uses it to format the errors into my specified output file, quickfix.out</p>
<p>That's a lot to type so of course it is mapped to my rspec_command in my vimrc like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Rspec.vim mappings
</span><span style="color:#e6db74">map &lt;Leader&gt;t :call RunCurrentSpecFile()&lt;CR&gt;
</span><span style="color:#e6db74">map &lt;Leader&gt;s :call RunNearestSpec()&lt;CR&gt;
</span><span style="color:#e6db74">map &lt;Leader&gt;l :call RunLastSpec()&lt;CR&gt;
</span><span style="color:#e6db74">map &lt;Leader&gt;* :call RunAllSpecs()&lt;CR&gt;
</span><span style="color:#e6db74">let g:rspec_command = &#39;call VimuxRunCommand(</span><span style="color:#e6db74">&#34;</span>bundle exec spring rspec <span style="color:#f92672">-</span><span style="color:#f92672">-</span>format progress <span style="color:#f92672">-</span><span style="color:#f92672">-</span>require <span style="color:#f92672">~</span><span style="color:#e6db74">/</span><span style="color:#e6db74">code</span><span style="color:#e6db74">/</span>rspec_support<span style="color:#f92672">/</span>quickfix_formatter<span style="color:#f92672">.</span>rb <span style="color:#f92672">-</span><span style="color:#f92672">-</span>format <span style="color:#66d9ef">QuickfixFormatter</span> <span style="color:#f92672">-</span><span style="color:#f92672">-</span>out quickfix<span style="color:#f92672">.</span>out {spec}\n<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">)&#39;
</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span> opens the quickfix file <span style="color:#f92672">and</span> window</code></pre></div>
<p>And I mapped leader q to open the quickfix window for these errors and focus on it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#e6db74">:map</span> <span style="color:#f92672">&lt;</span>leader<span style="color:#f92672">&gt;</span>q <span style="color:#e6db74">:cg</span> quickfix<span style="color:#f92672">.</span>out \<span style="color:#f92672">|</span> cwindow<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">CR</span><span style="color:#f92672">&gt;</span></code></pre></div>
<p>Now when I run my tests, I get my usual visual cues in my test pane, but if there are failures, I can quickly pull up a quickfix list in vim with <!-- raw HTML omitted -->q to jump to each failure.</p>
<p>Looks kind of like this in real life.  Notice I still get all my rspec detail on the right, but in my vim window I've got the quickfix list at the bottom for easy navigation.</p>
<p><a href="http://318ce10a4aff81d8fd77-9942159f0cde80bd1f0d981f1d813960.r48.cf1.rackcdn.com/mac-mini/Clipboard%20Image%2010-23-15,%201.52.54%20PM.png"><img src="http://318ce10a4aff81d8fd77-9942159f0cde80bd1f0d981f1d813960.r48.cf1.rackcdn.com/mac-mini/Clipboard%20Image%2010-23-15,%201.52.54%20PM.png" alt="Vim Quickfix Rspec"></a></p>
<p>So in closing:</p>
<ol>
<li>Create a little rspec formatter class.  Copy mine from <a href="https://github.com/pdbradley/rspec_support">github</a> if you want.  Save it somewhere convenient.</li>
<li>If you have a shortcut to run your rspec tests (surely you do; if not, why not?) modify it to require the rspec formatter code, use it, and direct its output to a file (quickfix.out is what I use)</li>
<li>In your vimrc create a shortcut to open that file as a quickfix file and use it to navigate to your test failures.</li>
</ol>
<p>If you have a better way to do this, or a better way to format the quickfix output, let me know.  I'm always ready to level up.</p>

</div>


  </div>
</section><footer class="footer">
  <div class="content has-text-centered">
    
    <p>
      Last modified January 01, 2020
      
      (commit 680bbe0)
      
    </p>
    
    
    <p>
      
      
    </p>
    
  </div>
</footer>


</body>
</html>
