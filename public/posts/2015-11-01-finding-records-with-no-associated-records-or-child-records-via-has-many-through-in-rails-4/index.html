<!DOCTYPE html>
<html lang="en">




<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    
    Finding records with no associated records (where child association does not exist) via has_many :through in Rails 4
     | Philip Bradley 
  </title>
  <link rel="stylesheet" href='http://www.philipbradley.net/css/site.min.eb4797a608f467160f71b5cc518dffb9b3fef0edc95e6def8dc4033ba1888b8f414e3d1d3e6c9804ca3e6f125539d8af48b28dcecb4eafc5805bde0b3c8d6956.css' integrity='sha512-60eXpgj0ZxYPcbXMUY3/ubP&#43;8O3JXm3vjcQDO6GIi49BTj0dPmyYBMo&#43;bxJVOdivSLKNzstOr8WAW94LPI1pVg=='>
  <link rel="canonical" href="http://www.philipbradley.net/posts/2015-11-01-finding-records-with-no-associated-records-or-child-records-via-has-many-through-in-rails-4/">
  <link rel="alternate" type="application/rss&#43;xml" href="http://www.philipbradley.net/index.xml" title="Philip Bradley">
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="author" content="Philip Bradley">
<meta name="description" content="Suppose you have the following Activerecord associations established:
Class Student has_many :class_sessions end Class ClassSession belongs_to :student end And you want to find out which students have no class sessions. Often I&#39;ve seen some interesting solutions like:
Student.all - Student.find(ClassSession.pluck(:student_id)) But this can get really bad if you ever have any reasonable amount of data to deal with. You can get what you want with a simple query:
Student.includes(:class_sessions).where(class_sessions: {id: nil}) When you use &ldquo;includes&rdquo; activerecord will use LEFT OUTER JOIN to include whatever associations you are asking for.">

<meta property="og:title" content="Finding records with no associated records (where child association does not exist) via has_many :through in Rails 4" />
<meta property="og:description" content="Suppose you have the following Activerecord associations established:
Class Student has_many :class_sessions end Class ClassSession belongs_to :student end And you want to find out which students have no class sessions. Often I&#39;ve seen some interesting solutions like:
Student.all - Student.find(ClassSession.pluck(:student_id)) But this can get really bad if you ever have any reasonable amount of data to deal with. You can get what you want with a simple query:
Student.includes(:class_sessions).where(class_sessions: {id: nil}) When you use &ldquo;includes&rdquo; activerecord will use LEFT OUTER JOIN to include whatever associations you are asking for." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.philipbradley.net/posts/2015-11-01-finding-records-with-no-associated-records-or-child-records-via-has-many-through-in-rails-4/" />
<meta property="article:published_time" content="2015-10-21T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-01-01T19:14:28-05:00" />


</head>
<body><nav class="navbar is-transparent " role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <a class="navbar-item" href="http://www.philipbradley.net/">
      <figure class="image">
        <img alt="" class="is-rounded" src="https://www.gravatar.com/avatar/17335e97ee934bff90fe4ddcaf0bb5fd?s=128&d=identicon">
      </figure>
    </a>
    <a class="navbar-item" href="http://www.philipbradley.net/">
      Philip Bradley
    </a>
  </div>
  
  <div class="navbar-menu">
    <div class="navbar-start">
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/ack/">
        
        Ack
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/activerecord/">
        
        Activerecord
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/bootcamps/">
        
        Bootcamps
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/capybara/">
        
        Capybara
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/flashcards/">
        
        Flashcards
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/git/">
        
        Git
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/rails/">
        
        Rails
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/refactoring/">
        
        Refactoring
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/ripgrep/">
        
        Ripgrep
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/rspec/">
        
        Rspec
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/ruby/">
        
        Ruby
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/search/">
        
        Search
        
      </a>
      
      <a class="navbar-item" href="http://www.philipbradley.net/tags/vim/">
        
        Vim
        
      </a>
      
    </div>
    
    <div class="navbar-end">
      
      <a class="navbar-item" href="https://github.com/orf/" rel="noopener" target="_blank">
        <span class="icon">
          <img alt="github-circle" src='http://www.philipbradley.net/icons/svg/github-circle.svg'>
        </span>
      </a>
      
      <a class="navbar-item" href="mailto:nope@example.com" target="_blank">
        <span class="icon">
          <img alt="email" src='http://www.philipbradley.net/icons/svg/email.svg'>
        </span>
      </a>
      <a class="navbar-item" href="http://www.philipbradley.net/index.xml" target="_blank">
        <span class="icon">
          <img alt="rss" src='http://www.philipbradley.net/icons/svg/rss.svg'>
        </span>
      </a>
      
    </div>
  </div>
</nav>
<section class="hero is-small is-info is-fullwidth">
  <div class="hero-body">
<div class="container">
  <h1 class="title">
    Finding records with no associated records (where child association does not exist) via has_many :through in Rails 4
  </h1>
  <h2 class="subtitle">
    <time datetime='2015-10-21T00:00:00Z'>
      October 21, 2015
    </time>
    
    <br>
    
    
    
    <a class="tag is-link" href="http://www.philipbradley.net/tags/ruby/">ruby</a>
    
    
    
    
    <a class="tag is-link" href="http://www.philipbradley.net/tags/activerecord/">activerecord</a>
    
    
    
    
    <a class="tag is-link" href="http://www.philipbradley.net/tags/rails/">rails</a>
    
    
    
  </h2>
</div>

  </div>
</section>
<section class="section">
  <div class="container">
<div class="content is-medium">
  <p>Suppose you have the following Activerecord associations established:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">Class</span> <span style="color:#66d9ef">Student</span> 
  has_many <span style="color:#e6db74">:class_sessions</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">Class</span> <span style="color:#66d9ef">ClassSession</span>
  belongs_to <span style="color:#e6db74">:student</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<p>And you want to find out which students have no class sessions.  Often I've seen some interesting solutions like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">Student</span><span style="color:#f92672">.</span>all <span style="color:#f92672">-</span> <span style="color:#66d9ef">Student</span><span style="color:#f92672">.</span>find(<span style="color:#66d9ef">ClassSession</span><span style="color:#f92672">.</span>pluck(<span style="color:#e6db74">:student_id</span>))</code></pre></div>
<p>But this can get really bad if you ever have any reasonable amount of data to deal with.  You can get what you want with a simple query:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">Student</span><span style="color:#f92672">.</span>includes(<span style="color:#e6db74">:class_sessions</span>)<span style="color:#f92672">.</span>where(<span style="color:#e6db74">class_sessions</span>: {id: <span style="color:#66d9ef">nil</span>})</code></pre></div>
<p>When you use &ldquo;includes&rdquo; activerecord will use LEFT OUTER JOIN to include whatever associations you are asking for.  In the result set, if associated records exist in the related tables, their values will will be included.  If the associated record(s) don't exist, the values for columns on the included association will be nil.</p>
<p>Which means if you check those associated columns for nil, you are essentially checking that the association is absent for that row.  Hence,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">Student</span><span style="color:#f92672">.</span>includes(<span style="color:#e6db74">:class_sessions</span>)<span style="color:#f92672">.</span>where(<span style="color:#e6db74">class_sessions</span>: {id: <span style="color:#66d9ef">nil</span>})</code></pre></div>
<p>Will, by checking for the absence of the class_sessions.id column, give you all the students without an associated class session.</p>
<p>What's nice is that this applies to indirect associations via has_many through.  Consider this arrangement where a student has class sessions through a join table called enrollments:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">Class</span> <span style="color:#66d9ef">Student</span> 
  has_many <span style="color:#e6db74">:class_sessions</span>, <span style="color:#e6db74">through</span>: <span style="color:#e6db74">:enrollments</span>
  has_many <span style="color:#e6db74">:enrollments</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">Class</span> <span style="color:#66d9ef">Enrollment</span>
  belongs_to <span style="color:#e6db74">:student</span>
  belongs_to <span style="color:#e6db74">:class_session</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">Class</span> <span style="color:#66d9ef">ClassSession</span>
  has_many <span style="color:#e6db74">:enrollments</span>
  has_many <span style="color:#e6db74">:students</span>, <span style="color:#e6db74">through</span>: <span style="color:#e6db74">:enrollments</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<p>How would you check to find students without any class sessions here?  Well, it's the same:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">Student</span><span style="color:#f92672">.</span>includes(<span style="color:#e6db74">:class_sessions</span>)<span style="color:#f92672">.</span>where(<span style="color:#e6db74">class_sessions</span>: {id: <span style="color:#66d9ef">nil</span>})</code></pre></div>
<p>Or if you wanted to be needlessly obtuse:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">Student</span><span style="color:#f92672">.</span>includes(<span style="color:#e6db74">:enrollments</span>)<span style="color:#f92672">.</span>where(<span style="color:#e6db74">enrollments</span>: {<span style="color:#e6db74">student_id</span>: <span style="color:#66d9ef">nil</span>})</code></pre></div>
<p>It's probably better to check for nil on the actual associated record and not the join table, just so it is clear what you are checking for.</p>
<p>Ok let's get crazy&ndash;what if you want to check on a really indirect association.  So building off what we had before lets add two more classes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">Class</span> <span style="color:#66d9ef">Student</span> 
  has_many <span style="color:#e6db74">:class_sessions</span>, <span style="color:#e6db74">through</span>: <span style="color:#e6db74">:enrollments</span>
  has_many <span style="color:#e6db74">:enrollments</span>
  has_many <span style="color:#e6db74">:teachers</span>, <span style="color:#e6db74">through</span>: <span style="color:#e6db74">:class_sessions</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">Class</span> <span style="color:#66d9ef">Enrollment</span>
  belongs_to <span style="color:#e6db74">:student</span>
  belongs_to <span style="color:#e6db74">:class_session</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">Class</span> <span style="color:#66d9ef">ClassSession</span>
  has_many <span style="color:#e6db74">:enrollments</span>
  has_many <span style="color:#e6db74">:students</span>, <span style="color:#e6db74">through</span>: <span style="color:#e6db74">:enrollments</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">Class</span> <span style="color:#66d9ef">Timeslot</span>
  belongs_to <span style="color:#e6db74">:teacher</span>
  belongs_to <span style="color:#e6db74">:class_session</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">Class</span> <span style="color:#66d9ef">Teacher</span>
  has_many <span style="color:#e6db74">:timeslots</span>
  has_many <span style="color:#e6db74">:class_sessions</span>, <span style="color:#e6db74">through</span>: <span style="color:#e6db74">:timeslots</span>
  has_many <span style="color:#e6db74">:students</span>, <span style="color:#e6db74">through</span>: <span style="color:#e6db74">:class_sessions</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<p>Er..this example is getting a little convoluted but it could happen.  Can you form a simple query to find students with no teachers?  Sure!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">Student</span><span style="color:#f92672">.</span>includes(<span style="color:#e6db74">:teachers</span>)<span style="color:#f92672">.</span>where(<span style="color:#e6db74">teachers</span>: {id: <span style="color:#66d9ef">nil</span>})</code></pre></div>
<p>The SQL that Activerecord generates is pretty gnarly but the Ruby/Rails is simple if not elegant.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">students</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">id</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">AS</span> t0_r0, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">students</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">name</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">AS</span> t0_r1, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">students</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">created_at</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">AS</span> t0_r2, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">students</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">updated_at</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">AS</span> t0_r3, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">teachers</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">id</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">AS</span> t1_r0, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">teachers</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">name</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">AS</span> t1_r1, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">teachers</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">created_at</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">AS</span> t1_r2, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">teachers</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">updated_at</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">AS</span> t1_r3 <span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">students</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">OUTER</span> <span style="color:#66d9ef">JOIN</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">enrollments</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">ON</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">enrollments</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">student_id</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">students</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">id</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">OUTER</span> <span style="color:#66d9ef">JOIN</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">class_sessions</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">ON</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">class_sessions</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">id</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">enrollments</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">class_session_id</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">OUTER</span> <span style="color:#66d9ef">JOIN</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">timeslots</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">ON</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">timeslots</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">class_session_id</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">class_sessions</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">id</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">OUTER</span> <span style="color:#66d9ef">JOIN</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">teachers</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">ON</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">teachers</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">id</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">timeslots</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">teacher_id</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">WHERE</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">teachers</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">id</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NULL</span></code></pre></div>
<p>Yep so that's one way to look for unassociated primary records.  If anyone has a better way or thinks I've said something stupid, let me know!  I'm always ready to level up.</p>

</div>


  </div>
</section><footer class="footer">
  <div class="content has-text-centered">
    
    <p>
      Last modified January 01, 2020
      
      (commit 680bbe0)
      
    </p>
    
    
    <p>
      
      
    </p>
    
  </div>
</footer>


</body>
</html>
